<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche √âtudiant | Kadima Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin.css">
    <style>
        .fiche-header {
            display: flex;
            gap: var(--spacing-6);
            margin-bottom: var(--spacing-6);
            align-items: flex-start;
        }

        .fiche-avatar {
            width: 120px;
            height: 120px;
            border-radius: var(--radius-lg);
            background: var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: var(--gray-400);
            overflow: hidden;
        }

        .fiche-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .fiche-info {
            flex: 1;
        }

        .fiche-name {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: var(--spacing-1);
        }

        .fiche-niu {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
            margin-bottom: var(--spacing-4);
        }

        .fiche-niu code {
            background: var(--gray-100);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-family: monospace;
        }

        .fiche-meta {
            display: flex;
            gap: var(--spacing-6);
            flex-wrap: wrap;
        }

        .fiche-meta-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            font-size: var(--font-size-sm);
            color: var(--gray-600);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--spacing-4);
        }

        .info-item {
            background: var(--gray-50);
            padding: var(--spacing-4);
            border-radius: var(--radius);
        }

        .info-label {
            font-size: var(--font-size-xs);
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--spacing-1);
        }

        .info-value {
            font-size: var(--font-size-base);
            color: var(--gray-800);
            font-weight: 500;
        }

        .info-value.empty {
            color: var(--gray-400);
            font-style: italic;
        }

        .statut-change {
            display: flex;
            gap: var(--spacing-3);
            align-items: flex-end;
            margin-bottom: var(--spacing-4);
            padding: var(--spacing-4);
            background: var(--gray-50);
            border-radius: var(--radius);
        }

        .statut-change .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .historique-list {
            margin-top: var(--spacing-4);
        }

        .historique-item {
            display: flex;
            gap: var(--spacing-4);
            padding: var(--spacing-3);
            border-bottom: 1px solid var(--gray-100);
        }

        .historique-date {
            min-width: 140px;
            font-size: var(--font-size-sm);
            color: var(--gray-500);
        }

        .historique-content {
            flex: 1;
        }

        .historique-user {
            font-size: var(--font-size-xs);
            color: var(--gray-400);
            margin-top: var(--spacing-1);
        }

        .section-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--spacing-4);
            padding-bottom: var(--spacing-2);
            border-bottom: 1px solid var(--gray-200);
        }
    </style>
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../images/logo-kadima.png" alt="Kadima" class="sidebar-logo">
                <div>
                    <div class="sidebar-title">Kadima</div>
                    <div class="sidebar-subtitle">Session 2026-2027</div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <a href="dashboard.html" class="nav-item">
                        <span class="nav-item-icon">üìä</span>
                        <span class="nav-item-text">Tableau de bord</span>
                    </a>
                    <a href="inscriptions.html" class="nav-item active">
                        <span class="nav-item-icon">üìã</span>
                        <span class="nav-item-text">Inscriptions</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Gestion</div>
                    <a href="bourses.html" class="nav-item">
                        <span class="nav-item-icon">üéì</span>
                        <span class="nav-item-text">Bourses</span>
                    </a>
                    <a href="paiements.html" class="nav-item">
                        <span class="nav-item-icon">üí≥</span>
                        <span class="nav-item-text">Paiements</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Administration</div>
                    <a href="utilisateurs.html" class="nav-item">
                        <span class="nav-item-icon">üë•</span>
                        <span class="nav-item-text">Utilisateurs</span>
                    </a>
                </div>
            </nav>
            <div style="padding: var(--spacing-4); border-top: 1px solid rgba(255,255,255,0.1);">
                <a href="#" class="nav-item" onclick="logout()">
                    <span class="nav-item-icon">üö™</span>
                    <span class="nav-item-text">D√©connexion</span>
                </a>
            </div>
        </aside>

        <!-- Main content -->
        <main class="admin-main">
            <header class="header">
                <div class="header-left">
                    <a href="dashboard.html" class="btn btn-outline btn-sm">‚Üê Retour</a>
                    <h1 class="header-title">Fiche √©tudiant</h1>
                </div>
                <div class="header-right">
                    <div class="user-menu">
                        <div class="user-avatar" id="userAvatar">AD</div>
                    </div>
                </div>
            </header>

            <div class="admin-content">
                <!-- En-t√™te fiche -->
                <div class="card mb-6">
                    <div class="card-body">
                        <div class="fiche-header">
                            <div class="fiche-avatar" id="photoEtudiant">üë§</div>
                            <div class="fiche-info">
                                <div class="fiche-name" id="nomComplet">Chargement...</div>
                                <div class="fiche-niu">NIU : <code id="niuValue">-</code></div>
                                <div class="fiche-meta">
                                    <div class="fiche-meta-item">üìÖ <span id="dateInscription">-</span></div>
                                    <div class="fiche-meta-item">üìß <span id="emailEtudiant">-</span></div>
                                    <div class="fiche-meta-item">üì± <span id="telEtudiant">-</span></div>
                                </div>
                            </div>
                            <div>
                                <span class="badge" id="badgeStatut">-</span>
                            </div>
                        </div>

                        <!-- Changement de statut -->
                        <div class="statut-change">
                            <div class="form-group">
                                <label class="form-label">Changer le statut</label>
                                <select class="form-control" id="nouveauStatut"></select>
                            </div>
                            <div class="form-group" style="flex: 2;">
                                <label class="form-label">Raison (optionnel)</label>
                                <input type="text" class="form-control" id="raisonStatut"
                                    placeholder="Expliquer la raison du changement...">
                            </div>
                            <button class="btn btn-primary" onclick="changerStatut()">Appliquer</button>
                        </div>
                    </div>
                </div>

                <!-- Onglets -->
                <div class="card">
                    <div class="tabs" id="tabsContainer">
                        <div class="tab active" data-tab="identite">Identit√©</div>
                        <div class="tab" data-tab="famille">Famille</div>
                        <div class="tab" data-tab="finances">Finances</div>
                        <div class="tab" data-tab="parcours">Parcours</div>
                        <div class="tab" data-tab="bourses">Bourses</div>
                        <div class="tab" data-tab="documents">Documents</div>
                        <div class="tab" data-tab="medical">‚ö†Ô∏è M√©dical</div>
                        <div class="tab" data-tab="technique">Technique</div>
                    </div>

                    <!-- Contenu onglets -->
                    <div class="card-body">
                        <!-- Identit√© -->
                        <div class="tab-content active" id="tab-identite">
                            <div class="info-grid" id="gridIdentite"></div>
                        </div>

                        <!-- Famille -->
                        <div class="tab-content" id="tab-famille">
                            <h3 class="section-title">Repr√©sentant l√©gal 1</h3>
                            <div class="info-grid" id="gridRL1"></div>
                            <h3 class="section-title mt-6">Repr√©sentant l√©gal 2</h3>
                            <div class="info-grid" id="gridRL2"></div>
                            <h3 class="section-title mt-6">Contact en Isra√´l</h3>
                            <div class="info-grid" id="gridContactIsrael"></div>
                        </div>

                        <!-- Finances -->
                        <div class="tab-content" id="tab-finances">
                            <div class="info-grid" id="gridFinances"></div>
                        </div>

                        <!-- Parcours -->
                        <div class="tab-content" id="tab-parcours">
                            <div class="info-grid" id="gridParcours"></div>
                        </div>

                        <!-- Bourses -->
                        <div class="tab-content" id="tab-bourses">
                            <div class="info-grid" id="gridBourses"></div>
                        </div>

                        <!-- Documents -->
                        <div class="tab-content" id="tab-documents">
                            <div class="info-grid" id="gridDocuments"></div>
                        </div>

                        <!-- M√©dical -->
                        <div class="tab-content" id="tab-medical">
                            <div class="alert alert-confidential mb-4">
                                <span>‚ö†Ô∏è</span>
                                <div>
                                    <strong>Donn√©es confidentielles</strong><br>
                                    Ces informations sont strictement r√©serv√©es √† l'usage m√©dical et ne doivent pas √™tre
                                    partag√©es.
                                </div>
                            </div>
                            <div class="info-grid" id="gridMedical"></div>
                        </div>

                        <!-- Technique -->
                        <div class="tab-content" id="tab-technique">
                            <h3 class="section-title">Donn√©es techniques de l'inscription</h3>
                            <div class="info-grid" id="gridTechnique"></div>
                            <h3 class="section-title mt-6">Historique des statuts</h3>
                            <div class="historique-list" id="historiqueStatuts">
                                <p class="text-muted">Aucun historique</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal d√©connexion -->
    <div class="modal-overlay" id="logoutModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Confirmer la d√©connexion</h3>
                <span class="modal-close" onclick="closeLogoutModal()">‚úï</span>
            </div>
            <div class="modal-body">
                <p>√ätes-vous s√ªr de vouloir vous d√©connecter ?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLogoutModal()">Non</button>
                <button class="btn btn-danger" onclick="confirmLogout()">Oui</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/admin';
        let authToken = localStorage.getItem('adminToken') || sessionStorage.getItem('adminToken');
        let inscription = null;

        // Get NIU from URL
        const urlParams = new URLSearchParams(window.location.search);
        const niu = urlParams.get('niu');

        if (!niu) {
            window.location.href = 'dashboard.html';
        }

        // Auth check
        async function checkAuth() {
            if (!authToken) {
                window.location.href = 'index.html';
                return false;
            }
            try {
                const res = await fetch(`${API_BASE}/verify`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!res.ok) {
                    window.location.href = 'index.html';
                    return false;
                }
                return true;
            } catch (e) {
                window.location.href = 'index.html';
                return false;
            }
        }

        // Load inscription
        async function loadInscription() {
            try {
                const res = await fetch(`${API_BASE}/inscriptions/${niu}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) {
                    alert('Inscription non trouv√©e');
                    window.location.href = 'dashboard.html';
                    return;
                }

                const data = await res.json();
                inscription = data.inscription;

                renderFiche(inscription);
                renderHistorique(data.historique || []);

            } catch (error) {
                console.error('Load error:', error);
            }
        }

        // Load statuts
        async function loadStatuts() {
            try {
                const res = await fetch(`${API_BASE}/statuts`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const select = document.getElementById('nouveauStatut');
                    select.innerHTML = data.statuts.map(s =>
                        `<option value="${s.code}">${s.libelle}</option>`
                    ).join('');
                }
            } catch (e) { }
        }

        // Render fiche
        function renderFiche(ins) {
            // Parse donn√©es compl√®tes
            const dc = ins.donnees_completes || {};
            const meta = ins.donnees_meta || {};

            // Header
            document.getElementById('nomComplet').textContent = `${ins.prenom || ''} ${ins.nom || ''}`.trim();
            document.getElementById('niuValue').textContent = ins.niu;
            document.getElementById('dateInscription').textContent = formatDate(ins.date_inscription);
            document.getElementById('emailEtudiant').textContent = ins.email || '-';
            document.getElementById('telEtudiant').textContent = ins.telephone || '-';

            // Badge statut
            const badge = document.getElementById('badgeStatut');
            badge.textContent = ins.statut_libelle || ins.statut_code || 'Inconnu';
            badge.className = `badge badge-${getStatutClass(ins.statut_code)}`;

            // Select statut courant
            const select = document.getElementById('nouveauStatut');
            if (ins.statut_code && select.querySelector(`option[value="${ins.statut_code}"]`)) {
                select.value = ins.statut_code;
            }

            // Identit√©
            renderGrid('gridIdentite', [
                { label: 'Nom', value: ins.nom },
                { label: 'Pr√©nom', value: ins.prenom },
                { label: 'Date de naissance', value: formatDate(ins.date_naissance) },
                { label: 'Lieu de naissance', value: ins.lieu_naissance },
                { label: 'Nationalit√©', value: ins.nationalite },
                { label: 'Email', value: ins.email },
                { label: 'T√©l√©phone', value: ins.telephone },
                { label: 'Num√©ro de passeport', value: ins.passeport || dc.passeport },
                { label: 'Adresse', value: ins.adresse },
                { label: 'Code postal', value: ins.code_postal },
                { label: 'Ville', value: ins.ville },
                { label: 'Pays', value: ins.pays }
            ]);

            // Famille - RL1
            renderGrid('gridRL1', [
                { label: 'Type', value: dc.rl1Type },
                { label: 'Nom', value: dc.rl1Nom },
                { label: 'Pr√©nom', value: dc.rl1Prenom },
                { label: 'T√©l√©phone', value: dc.rl1Telephone },
                { label: 'Email', value: dc.rl1Email },
                { label: 'Profession', value: dc.rl1Profession },
                { label: 'Adresse', value: dc.rl1Adresse }
            ]);

            // Famille - RL2
            renderGrid('gridRL2', [
                { label: 'Type', value: dc.rl2Type },
                { label: 'Nom', value: dc.rl2Nom },
                { label: 'Pr√©nom', value: dc.rl2Prenom },
                { label: 'T√©l√©phone', value: dc.rl2Telephone },
                { label: 'Email', value: dc.rl2Email }
            ]);

            // Contact Isra√´l
            renderGrid('gridContactIsrael', [
                { label: 'Nom', value: dc.contactIsraelNom },
                { label: 'T√©l√©phone', value: dc.contactIsraelTelephone },
                { label: 'Lien', value: dc.contactIsraelLien }
            ]);

            // Finances
            renderGrid('gridFinances', [
                { label: 'Revenus mensuels du foyer', value: formatMontant(dc.revenusMensuels, '‚Ç¨') },
                { label: 'Allocations CAF', value: formatMontant(dc.allocationsCaf, '‚Ç¨') },
                { label: 'Loyer mensuel', value: formatMontant(dc.loyerMensuel, '‚Ç¨') },
                { label: 'Personnes au foyer', value: dc.nbPersonnesFoyer },
                { label: 'Enfants √† charge', value: dc.nbEnfantsCharge },
                { label: 'Quotient familial', value: dc.quotientFamilial },
                { label: 'Co√ªt scolarit√© pr√©c√©dente', value: formatMontant(dc.coutScolaritePrecedente, '‚Ç¨') },
                { label: 'Participation possible', value: formatMontant(dc.participationPossible, '‚Ç¨') },
                { label: 'Bourse CROUS', value: dc.bourseCrous ? 'Oui' : 'Non' },
                { label: '√âchelon CROUS', value: dc.echelonCrous },
                { label: 'Montant CROUS', value: formatMontant(dc.montantCrous, '‚Ç¨') },
                { label: 'Autres bourses', value: dc.autresBourses },
                { label: 'Travail √©tudiant', value: dc.travailEtudiant ? 'Oui' : 'Non' },
                { label: 'Type de travail', value: dc.typeTravail },
                { label: 'Revenu travail', value: formatMontant(dc.travailRevenu, dc.deviseTravail || '‚Ç¨') }
            ]);

            // Parcours
            renderGrid('gridParcours', [
                { label: 'Baccalaur√©at', value: dc.baccalaureat },
                { label: 'Dernier dipl√¥me', value: dc.diplomeObtenu },
                { label: 'Niveau d\'h√©breu (parl√©)', value: dc.hebreuParle },
                { label: 'Niveau d\'h√©breu (lu)', value: dc.hebreuLu },
                { label: 'Niveau d\'h√©breu (√©crit)', value: dc.hebreuEcrit },
                { label: 'Activit√© associative', value: dc.activiteAssociative },
                { label: 'Hobby / Passion', value: dc.hobby },
                { label: 'Motivations', value: dc.motivations }
            ]);

            // Bourses
            renderGrid('gridBourses', [
                { label: 'Demande COBY', value: dc.demandeCoby ? 'Oui' : 'Non' },
                { label: 'Demande MASSA', value: dc.demandeMassa ? 'Oui' : 'Non' },
                { label: 'Demande TEVMI', value: dc.demandeTevmi ? 'Oui' : 'Non' }
            ]);

            // Documents
            const docs = ins.documents || {};
            renderGrid('gridDocuments', Object.entries(docs).map(([key, path]) => ({
                label: key,
                value: path ? `üìÑ ${path.split('/').pop()}` : 'Non fourni'
            })));

            // M√©dical
            renderGrid('gridMedical', [
                { label: 'Allergies', value: dc.allergies },
                { label: 'D√©tail allergies', value: dc.allergiesDetail },
                { label: 'Traitements m√©dicaux', value: dc.traitements },
                { label: 'D√©tail traitements', value: dc.traitementsDetail },
                { label: 'Suivi psychologique', value: dc.suiviPsy },
                { label: 'D√©tail suivi psy', value: dc.suiviPsyDetail }
            ]);

            // Technique
            renderGrid('gridTechnique', [
                { label: 'ID inscription', value: ins.id },
                { label: 'NIU', value: ins.niu },
                { label: 'Session', value: ins.session },
                { label: 'Date inscription', value: formatDateTime(ins.date_inscription) },
                { label: 'Derni√®re modification', value: formatDateTime(ins.date_modification) },
                { label: 'Adresse IP', value: meta.ip || '-' },
                { label: 'Navigateur', value: meta.userAgent ? meta.userAgent.substring(0, 80) + '...' : '-' },
                { label: 'Horodatage client', value: meta.timestamp || '-' }
            ]);
        }

        function renderGrid(containerId, items) {
            const container = document.getElementById(containerId);
            container.innerHTML = items.map(item => `
                <div class="info-item">
                    <div class="info-label">${item.label}</div>
                    <div class="info-value ${item.value ? '' : 'empty'}">${item.value || 'Non renseign√©'}</div>
                </div>
            `).join('');
        }

        function renderHistorique(historique) {
            const container = document.getElementById('historiqueStatuts');
            if (historique.length === 0) {
                container.innerHTML = '<p class="text-muted">Aucun historique de changement de statut</p>';
                return;
            }
            container.innerHTML = historique.map(h => `
                <div class="historique-item">
                    <div class="historique-date">${formatDateTime(h.date_modification)}</div>
                    <div class="historique-content">
                        <strong>${h.statut_precedent_libelle || h.statut_precedent || '-'}</strong> 
                        ‚Üí 
                        <strong>${h.statut_nouveau_libelle || h.statut_nouveau}</strong>
                        ${h.raison ? `<br><em>"${h.raison}"</em>` : ''}
                        <div class="historique-user">
                            Par ${h.utilisateur_nom || 'Syst√®me'} ${h.utilisateur_prenom || ''} 
                            ${h.adresse_ip ? `(IP: ${h.adresse_ip})` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Changer statut
        async function changerStatut() {
            const statut = document.getElementById('nouveauStatut').value;
            const raison = document.getElementById('raisonStatut').value;

            try {
                const res = await fetch(`${API_BASE}/inscriptions/${niu}/statut`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ statut, raison })
                });

                if (res.ok) {
                    document.getElementById('raisonStatut').value = '';
                    loadInscription();
                } else {
                    const data = await res.json();
                    alert(data.message || 'Erreur');
                }
            } catch (e) {
                alert('Erreur de connexion');
            }
        }

        // Helpers
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('fr-FR');
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return `${d.toLocaleDateString('fr-FR')} ${d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
        }

        function formatMontant(val, devise) {
            if (!val && val !== 0) return '-';
            return `${Number(val).toLocaleString('fr-FR')} ${devise}`;
        }

        function getStatutClass(code) {
            const map = {
                'RECU': 'recu', 'A_TRAITER': 'a-traiter', 'INCOMPLET': 'incomplet',
                'EN_ATTENTE': 'en-attente', 'VALIDE': 'valide', 'EN_COURS': 'en-cours',
                'REFUSE': 'refuse', 'RENVOYE': 'renvoye', 'ABANDONNE': 'abandonne',
                'TERMINE': 'termine', 'ARCHIVE': 'archive'
            };
            return map[code] || 'en-attente';
        }

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
            });
        });

        // Logout
        function logout() {
            document.getElementById('logoutModal').classList.add('active');
        }
        function closeLogoutModal() {
            document.getElementById('logoutModal').classList.remove('active');
        }
        async function confirmLogout() {
            localStorage.removeItem('adminToken');
            sessionStorage.removeItem('adminToken');
            window.location.href = 'index.html';
        }

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            if (await checkAuth()) {
                await loadStatuts();
                await loadInscription();
            }
        });
    </script>
</body>

</html>